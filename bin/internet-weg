#!/bin/sh

set -o errexit
set -o nounset

NETWORK_INTERFACE="en0"
NO_WIFI="You are not associated with an AirPort network."

NO_WAN_IP="var wan_ip='';"
WAN_IP=${NO_WAN_IP}

networksetup -setairportpower ${NETWORK_INTERFACE} on

while : ; do
    echo Checking…
    WIFI=$(networksetup -getairportnetwork ${NETWORK_INTERFACE})
    if [ "${WIFI}" == "${NO_WIFI}" ]; then
        echo Reconnect Wi-Fi…
        networksetup -setairportpower ${NETWORK_INTERFACE} off
        networksetup -setairportpower ${NETWORK_INTERFACE} on
        sleep 13
        continue
    fi
    WAN_IP=$(curl --silent http://easy.box/ | grep "wan_ip=")
    [ "${WAN_IP}" = "" -o "${WAN_IP}" = "${NO_WAN_IP}" ] || break
    sleep 3
done

say "Internet connected"
